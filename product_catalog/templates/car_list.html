{% extends 'base.html' %} 
{% load static %}

{% block meta %}
<title>Katalog | BekasBerkelas</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="overflow-x-hidden px-3 sm:px-4 md:px-8 pb-6 sm:pb-8 pt-20 sm:pt-24 min-h-screen bg-blue-100">
    <div class="w-full max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold text-[#1f1c61] mb-6">Katalog</h1>

        <div class="bg-white rounded-lg p-6 shadow-sm mb-6">
            <form method="GET" action="{% url 'product_catalog:car_list' %}">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
                    <div class="lg:col-span-3">
                        <input type="text" name="car_name" id="car_name" 
                               placeholder="Car Name" value="{{ form.car_name.value|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <input type="text" name="brand" id="brand" 
                               placeholder="Brand" value="{{ form.brand.value|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-5 gap-4">
                    <div>
                        <button type="button" id="toggle-filters"
                                class="w-full h-full bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition duration-300 whitespace-normal">
                            Show/Hide Additional Filters
                        </button>
                    </div>

                    <div class="col-span-4">
                        <div id="additional-filters" style="display:none;">
                            <div class="space-y-4">
                                <input type="number" name="mileage" id="mileage" 
                                       placeholder="Mileage" value="{{ form.mileage.value|default:'' }}"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                
                                <input type="text" name="location" id="location" 
                                       placeholder="Location" value="{{ form.location.value|default:'' }}"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                
                                <select name="transmission" id="transmission" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Transmission:</option>
                                    {% for choice in form.transmission.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == form.transmission.value %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                
                                <select name="plate_type" id="plate_type" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Plate Type</option>
                                    {% for choice in form.plate_type.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == form.plate_type.value %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>

                                <div class="grid grid-cols-2 md:grid-cols-6 gap-x-4 gap-y-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="rear_camera" {% if form.rear_camera.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Rear Camera</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="sun_roof" {% if form.sun_roof.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Sun Roof</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="auto_retract_mirror" {% if form.auto_retract_mirror.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Auto Retract Mirror</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="electric_parking_brake" {% if form.electric_parking_brake.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Electric Parking Brake</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="map_navigator" {% if form.map_navigator.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Map Navigator</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="vehicle_stability_control" {% if form.vehicle_stability_control.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Vehicle Stability Control</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="keyless_push_start" {% if form.keyless_push_start.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Keyless Push Start</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="sports_mode" {% if form.sports_mode.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Sports Mode</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="camera_360_view" {% if form.camera_360_view.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Camera 360 View</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="power_sliding_door" {% if form.power_sliding_door.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Power Sliding Door</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="auto_cruise_control" {% if form.auto_cruise_control.value %}checked{% endif %}
                                               class="rounded border-gray-300">
                                        <span class="text-sm">Auto Cruise Control</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 rounded-lg transition duration-300">
                        Filter
                    </button>
                </div>
            </form>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for car in cars %}
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                {% if car.image_url %}
                <img src="{{ car.image_url }}" alt="{{ car.car_name }}" 
                     class="w-full h-48 object-cover">
                {% endif %}
                
                <div class="p-4">
                    <h3 class="text-lg font-semibold">{{ car.car_name }}</h3>
                    <p class="text-blue-500 font-bold">Rp {{ car.price }}</p>
                    
                    <div class="mt-4 space-y-2">
                        {% if request.user.userprofile.role == 'ADM' %}
                        <div class="flex gap-2">
                            <form method="POST" action="{% url 'product_catalog:view_details' car.id %}" class="flex-1">
                                {% csrf_token %}
                                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
                                    View Details
                                </button>
                            </form>
                            <form method="POST" action="{% url 'product_catalog:delete_car' car.id %}" class="flex-1">
                                {% csrf_token %}
                                <button type="submit" 
                                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300"
                                        onclick="return confirm('Are you sure you want to delete this car?');">
                                    Delete
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <div class="flex gap-2">
                            <form method="POST" action="{% url 'product_catalog:view_details' car.id %}" class="flex-1">
                                {% csrf_token %}
                                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
                                    View Details
                                </button>
                            </form>
                            <button onclick="addToWishlist('{{ car.id }}')"
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
                                Add to Wishlist
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-8 text-gray-500">
                No cars available.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.getElementById('toggle-filters').addEventListener('click', function() {
    var additionalFilters = document.getElementById('additional-filters');
    if (additionalFilters.style.display === 'none' || additionalFilters.style.display === '') {
        additionalFilters.style.display = 'block';
    } else {
        additionalFilters.style.display = 'none';
    }
});

function addToWishlist(carId) {
    fetch(`/wishlist/add/${carId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ car_id: carId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
        } else {
            alert(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock content %}